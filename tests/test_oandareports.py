from unittest import TestCase
import dask.dataframe as dd
import pandas as pd
from unittest.mock import patch, MagicMock
from luigi.mock import MockTarget
from luigi import build, ExternalTask, format, Parameter, Task
from luigi.parameter import MissingParameterException, UnknownParameterException
from luigi.contrib.s3 import S3Target
from luigi import LocalTarget
from luigi.execution_summary import LuigiStatusCode
from unittest import TestCase
from tools.historicrates import GetHistoricRates
from tools.tradinghistory import GetTradingHistory
from tools.create_pdf import PdfReport
from reports.volatility import VolatilityReport
from reports.exposure import ExposureReport
from reports.financing import FinancingReport
from reports.opentrades import OpenTradesReport
from reports.netasset import NetAssetReport
from reports.correlation import CorrelationReport

# The workflows in this project is closely tied to downloading data from
# external sources. Hence, dependent on correct credentials and live servers.
# The Oanda API is often unreachable in the weekends due to maintenance.
# Hence, we should not set up automatic tests that are dependent on this.
# But in the development phase, it is important to test that everything works.
# Hence, I have left a number of tests commented out below, that may be run
# when appropriate during development, with a correct .env. They have all
# been used in the development phase, and should work if you want to try them
# It's just that Travis does not like them ;-)

# More tests with fake data below


def build_func(func, **kwargs):
    return build([func(**kwargs)], local_scheduler=True, detailed_summary=True).status


class TasksDataTests(TestCase):
    def test_GetHistoricRates(self):
        """Ensure GetHistoricRates works correctly and as expected"""
        with self.assertRaises(MissingParameterException):
            build_func(GetHistoricRates, instrument="EUR_USD")

        #with patch('luigi.LocalTarget.exists', MagicMock(return_value=True)):
         #self.assertEqual(build_func(GetHistoricRates, instrument='EUR_USD', granularity='S5'), LuigiStatusCode.SUCCESS)

    def test_GetTradingHistory(self):
        """Ensure GetTradingHistory works correctly and as expected"""
        with self.assertRaises(UnknownParameterException):
            build_func(GetTradingHistory, instrument="EUR_USD")

        #with patch('luigi.LocalTarget.exists', MagicMock(return_value=True)):
            #self.assertEqual(build_func(GetTradingHistory), LuigiStatusCode.SUCCESS)

    def test_VolatilityReport(self):
        """Ensure GetTradingHistory works correctly and as expected"""
        with self.assertRaises(MissingParameterException):
            build_func(VolatilityReport)

        #with patch('luigi.LocalTarget.exists', MagicMock(return_value=True)):
            #self.assertEqual(build_func(GetTradingHistory), LuigiStatusCode.SUCCESS)

    def test_ExposureReport(self):
        #self.assertEqual(build_func(ExposureReport), LuigiStatusCode.SUCCESS)
        pass

    def test_FinancingReport(self):
        #self.assertEqual(build_func(FinancingReport), LuigiStatusCode.SUCCESS)
        pass

    def test_OpenTradesReport(self):
        #self.assertEqual(build_func(OpenTradesReport), LuigiStatusCode.SUCCESS)
        pass

    def test_NetAssetReport(self):
        #self.assertEqual(build_func(NetAssetReport), LuigiStatusCode.SUCCESS)
        pass

    def test_PdfReport(self):
        #self.assertEqual(build_func(PdfReport), LuigiStatusCode.SUCCESS)
        pass

    def test_CorrelationReport(self):
        with self.assertRaises(MissingParameterException):
            build_func(CorrelationReport)
        #self.assertEqual(build_func(CorrelationReport, granularity='H1'), LuigiStatusCode.SUCCESS)


class TestLuigiTasks(TestCase):
    """Tests for Dask Tasks"""

    def setUp(self):
        """Set up example dataframes"""

        self.npartitions = 2

        self.trading_history = pd.DataFrame(
            {
                "type": {
                    10: "LIMIT_ORDER",
                    11: "LIMIT_ORDER",
                    12: "LIMIT_ORDER",
                    13: "ORDER_CANCEL",
                    14: "LIMIT_ORDER",
                    15: "ORDER_CANCEL",
                    16: "LIMIT_ORDER",
                    17: "ORDER_CANCEL",
                    18: "LIMIT_ORDER",
                    19: "ORDER_CANCEL",
                    20: "LIMIT_ORDER",
                    21: "ORDER_CANCEL",
                    22: "LIMIT_ORDER",
                    23: "ORDER_CANCEL",
                    24: "LIMIT_ORDER",
                    25: "LIMIT_ORDER",
                    26: "ORDER_CANCEL",
                    27: "ORDER_CANCEL",
                    28: "LIMIT_ORDER",
                    29: "LIMIT_ORDER",
                },
                "divisionID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "siteID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "accountUserID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "accountNumber": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "homeCurrency": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "id": {
                    10: "11",
                    11: "12",
                    12: "13",
                    13: "14",
                    14: "15",
                    15: "16",
                    16: "17",
                    17: "18",
                    18: "19",
                    19: "20",
                    20: "21",
                    21: "22",
                    22: "23",
                    23: "24",
                    24: "25",
                    25: "26",
                    26: "27",
                    27: "28",
                    28: "29",
                    29: "30",
                },
                "accountID": {
                    10: "001-004-3001993-008",
                    11: "001-004-3001993-008",
                    12: "001-004-3001993-008",
                    13: "001-004-3001993-008",
                    14: "001-004-3001993-008",
                    15: "001-004-3001993-008",
                    16: "001-004-3001993-008",
                    17: "001-004-3001993-008",
                    18: "001-004-3001993-008",
                    19: "001-004-3001993-008",
                    20: "001-004-3001993-008",
                    21: "001-004-3001993-008",
                    22: "001-004-3001993-008",
                    23: "001-004-3001993-008",
                    24: "001-004-3001993-008",
                    25: "001-004-3001993-008",
                    26: "001-004-3001993-008",
                    27: "001-004-3001993-008",
                    28: "001-004-3001993-008",
                    29: "001-004-3001993-008",
                },
                "userID": {
                    10: 3001993,
                    11: 3001993,
                    12: 3001993,
                    13: 3001993,
                    14: 3001993,
                    15: 3001993,
                    16: 3001993,
                    17: 3001993,
                    18: 3001993,
                    19: 3001993,
                    20: 3001993,
                    21: 3001993,
                    22: 3001993,
                    23: 3001993,
                    24: 3001993,
                    25: 3001993,
                    26: 3001993,
                    27: 3001993,
                    28: 3001993,
                    29: 3001993,
                },
                "batchID": {
                    10: "11",
                    11: "12",
                    12: "13",
                    13: "14",
                    14: "15",
                    15: "16",
                    16: "17",
                    17: "18",
                    18: "19",
                    19: "20",
                    20: "21",
                    21: "22",
                    22: "23",
                    23: "24",
                    24: "25",
                    25: "26",
                    26: "27",
                    27: "28",
                    28: "29",
                    29: "30",
                },
                "requestID": {
                    10: "114681001000370475",
                    11: "114681001050740977",
                    12: "114681001147291511",
                    13: "114681001193467331",
                    14: "114681001235445645",
                    15: "114681001281621432",
                    16: "114681001739174862",
                    17: "114681001781151712",
                    18: "114681001823129107",
                    19: "114681001869304352",
                    20: "114681002734052891",
                    21: "114681002780227472",
                    22: "114681002855790157",
                    23: "114681002906162173",
                    24: "114681003044690909",
                    25: "114681003048885759",
                    26: "114681003090866020",
                    27: "114681003095061379",
                    28: "114681003149631586",
                    29: "114681003149631902",
                },
                "time": {
                    10: "2019-10-28T15:45:32.785213677Z",
                    11: "2019-10-28T15:45:44.143118370Z",
                    12: "2019-10-28T15:46:07.425240598Z",
                    13: "2019-10-28T15:46:18.460046087Z",
                    14: "2019-10-28T15:46:28.743150925Z",
                    15: "2019-10-28T15:46:39.800032505Z",
                    16: "2019-10-28T15:48:28.414159350Z",
                    17: "2019-10-28T15:48:38.222956112Z",
                    18: "2019-10-28T15:48:48.209222780Z",
                    19: "2019-10-28T15:48:59.279257669Z",
                    20: "2019-10-28T15:52:25.431243556Z",
                    21: "2019-10-28T15:52:36.181695809Z",
                    22: "2019-10-28T15:52:54.921419903Z",
                    23: "2019-10-28T15:53:06.504027191Z",
                    24: "2019-10-28T15:53:39.994758008Z",
                    25: "2019-10-28T15:53:40.164870835Z",
                    26: "2019-10-28T15:53:50.897406728Z",
                    27: "2019-10-28T15:53:51.178430339Z",
                    28: "2019-10-28T15:54:04.108341505Z",
                    29: "2019-10-28T15:54:04.241391250Z",
                },
                "marginRate": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "alias": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "accountBalance": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "amount": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "fundingReason": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "instrument": {
                    10: "USD_SEK",
                    11: "USD_SEK",
                    12: "USD_SEK",
                    13: None,
                    14: "USD_SEK",
                    15: None,
                    16: "USD_SEK",
                    17: None,
                    18: "USD_SEK",
                    19: None,
                    20: "USD_SEK",
                    21: None,
                    22: "USD_SEK",
                    23: None,
                    24: "USD_SEK",
                    25: "USD_SEK",
                    26: None,
                    27: None,
                    28: "USD_SEK",
                    29: "USD_SEK",
                },
                "units": {
                    10: "50",
                    11: "50",
                    12: "50",
                    13: "50",
                    14: "50",
                    15: "50",
                    16: "50",
                    17: "50",
                    18: "50",
                    19: "50",
                    20: "50",
                    21: "50",
                    22: "50",
                    23: "50",
                    24: "50",
                    25: "50",
                    26: "50",
                    27: "50",
                    28: "50",
                    29: "50",
                },
                "timeInForce": {
                    10: "GTC",
                    11: "GTC",
                    12: "GTC",
                    13: None,
                    14: "GTC",
                    15: None,
                    16: "GTC",
                    17: None,
                    18: "GTC",
                    19: None,
                    20: "GTC",
                    21: None,
                    22: "GTC",
                    23: None,
                    24: "GTC",
                    25: "GTC",
                    26: None,
                    27: None,
                    28: "GTC",
                    29: "GTC",
                },
                "positionFill": {
                    10: "DEFAULT",
                    11: "DEFAULT",
                    12: "DEFAULT",
                    13: None,
                    14: "DEFAULT",
                    15: None,
                    16: "DEFAULT",
                    17: None,
                    18: "DEFAULT",
                    19: None,
                    20: "DEFAULT",
                    21: None,
                    22: "DEFAULT",
                    23: None,
                    24: "DEFAULT",
                    25: "DEFAULT",
                    26: None,
                    27: None,
                    28: "DEFAULT",
                    29: "DEFAULT",
                },
                "reason": {
                    10: "CLIENT_ORDER",
                    11: "CLIENT_ORDER",
                    12: "CLIENT_ORDER",
                    13: "CLIENT_REQUEST",
                    14: "CLIENT_ORDER",
                    15: "CLIENT_REQUEST",
                    16: "CLIENT_ORDER",
                    17: "CLIENT_REQUEST",
                    18: "CLIENT_ORDER",
                    19: "CLIENT_REQUEST",
                    20: "CLIENT_ORDER",
                    21: "CLIENT_REQUEST",
                    22: "CLIENT_ORDER",
                    23: "CLIENT_REQUEST",
                    24: "CLIENT_ORDER",
                    25: "CLIENT_ORDER",
                    26: "CLIENT_REQUEST",
                    27: "CLIENT_REQUEST",
                    28: "CLIENT_ORDER",
                    29: "CLIENT_ORDER",
                },
                "orderID": {
                    10: None,
                    11: None,
                    12: None,
                    13: "11",
                    14: None,
                    15: "15",
                    16: None,
                    17: "17",
                    18: None,
                    19: "19",
                    20: None,
                    21: "10",
                    22: None,
                    23: "12",
                    24: None,
                    25: None,
                    26: "25",
                    27: "26",
                    28: None,
                    29: None,
                },
                "requestedUnits": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "price": {
                    10: "9.69500",
                    11: "9.69700",
                    12: "9.69800",
                    13: None,
                    14: "9.69300",
                    15: None,
                    16: "9.69300",
                    17: None,
                    18: "9.69300",
                    19: None,
                    20: "9.69900",
                    21: None,
                    22: "9.70000",
                    23: None,
                    24: "9.69500",
                    25: "9.69200",
                    26: None,
                    27: None,
                    28: "9.69700",
                    29: "9.69600",
                },
                "pl": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "financing": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "commission": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "gainQuoteHomeConversionFactor": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "lossQuoteHomeConversionFactor": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "guaranteedExecutionFee": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "halfSpreadCost": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "fullVWAP": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "tradeID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "triggerCondition": {
                    10: "DEFAULT",
                    11: "DEFAULT",
                    12: "DEFAULT",
                    13: None,
                    14: "DEFAULT",
                    15: None,
                    16: "DEFAULT",
                    17: None,
                    18: "DEFAULT",
                    19: None,
                    20: "DEFAULT",
                    21: None,
                    22: "DEFAULT",
                    23: None,
                    24: "DEFAULT",
                    25: "DEFAULT",
                    26: None,
                    27: None,
                    28: "DEFAULT",
                    29: "DEFAULT",
                },
                "partialFill": {
                    10: "DEFAULT",
                    11: "DEFAULT",
                    12: "DEFAULT",
                    13: None,
                    14: "DEFAULT",
                    15: None,
                    16: "DEFAULT",
                    17: None,
                    18: "DEFAULT",
                    19: None,
                    20: "DEFAULT",
                    21: None,
                    22: "DEFAULT",
                    23: None,
                    24: "DEFAULT",
                    25: "DEFAULT",
                    26: None,
                    27: None,
                    28: "DEFAULT",
                    29: "DEFAULT",
                },
                "accountFinancingMode": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "closedTradeID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "tradeCloseTransactionID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "replacedByOrderID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "replacesOrderID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
                "cancellingTransactionID": {
                    10: None,
                    11: None,
                    12: None,
                    13: None,
                    14: None,
                    15: None,
                    16: None,
                    17: None,
                    18: None,
                    19: None,
                    20: None,
                    21: None,
                    22: None,
                    23: None,
                    24: None,
                    25: None,
                    26: None,
                    27: None,
                    28: None,
                    29: None,
                },
            }
        )
        # convert to dask
        self.trading_history_dd = dd.from_pandas(
            self.trading_history, npartitions=self.npartitions
        )

        self.rates = pd.DataFrame(
            {
                "complete": {
                    10: True,
                    11: True,
                    12: True,
                    13: True,
                    14: True,
                    15: True,
                    16: True,
                    17: True,
                    18: True,
                    19: True,
                    20: True,
                    21: True,
                    22: True,
                    23: True,
                    24: True,
                    25: True,
                    26: True,
                    27: True,
                    28: True,
                    29: True,
                },
                "volume": {
                    10: 2953,
                    11: 2846,
                    12: 3569,
                    13: 2567,
                    14: 3133,
                    15: 2336,
                    16: 2827,
                    17: 1331,
                    18: 960,
                    19: 2632,
                    20: 3209,
                    21: 2843,
                    22: 3243,
                    23: 2755,
                    24: 3042,
                    25: 2573,
                    26: 2913,
                    27: 2995,
                    28: 2658,
                    29: 3019,
                },
                "time": {
                    10: "2003-10-31T22:00:00.000000000Z",
                    11: "2003-11-07T22:00:00.000000000Z",
                    12: "2003-11-14T22:00:00.000000000Z",
                    13: "2003-11-21T22:00:00.000000000Z",
                    14: "2003-11-28T22:00:00.000000000Z",
                    15: "2003-12-05T22:00:00.000000000Z",
                    16: "2003-12-12T22:00:00.000000000Z",
                    17: "2003-12-19T22:00:00.000000000Z",
                    18: "2003-12-26T22:00:00.000000000Z",
                    19: "2004-01-02T22:00:00.000000000Z",
                    20: "2004-01-09T22:00:00.000000000Z",
                    21: "2004-01-16T22:00:00.000000000Z",
                    22: "2004-01-23T22:00:00.000000000Z",
                    23: "2004-01-30T22:00:00.000000000Z",
                    24: "2004-02-06T22:00:00.000000000Z",
                    25: "2004-02-13T22:00:00.000000000Z",
                    26: "2004-02-20T22:00:00.000000000Z",
                    27: "2004-02-27T22:00:00.000000000Z",
                    28: "2004-03-05T22:00:00.000000000Z",
                    29: "2004-03-12T22:00:00.000000000Z",
                },
                "o": {
                    10: "28.278",
                    11: "29.506",
                    12: "29.486",
                    13: "29.174",
                    14: "28.331",
                    15: "28.932",
                    16: "29.996",
                    17: "30.180",
                    18: "29.449",
                    19: "29.995",
                    20: "31.639",
                    21: "30.781",
                    22: "30.681",
                    23: "28.827",
                    24: "28.980",
                    25: "30.662",
                    26: "30.712",
                    27: "32.426",
                    28: "33.545",
                    29: "32.151",
                },
                "h": {
                    10: "29.368",
                    11: "29.900",
                    12: "30.655",
                    13: "29.204",
                    14: "29.709",
                    15: "30.643",
                    16: "31.394",
                    17: "30.180",
                    18: "30.336",
                    19: "31.865",
                    20: "31.816",
                    21: "31.475",
                    22: "30.953",
                    23: "30.428",
                    24: "30.925",
                    25: "31.497",
                    26: "32.438",
                    27: "33.638",
                    28: "33.614",
                    29: "33.825",
                },
                "l": {
                    10: "27.192",
                    11: "28.698",
                    12: "28.778",
                    13: "27.493",
                    14: "27.829",
                    15: "28.932",
                    16: "29.712",
                    17: "28.662",
                    18: "29.296",
                    19: "29.944",
                    20: "29.497",
                    21: "30.355",
                    22: "28.912",
                    23: "28.504",
                    24: "28.798",
                    25: "30.111",
                    26: "30.621",
                    27: "32.065",
                    28: "31.315",
                    29: "32.020",
                },
                "c": {
                    10: "29.095",
                    11: "29.679",
                    12: "29.477",
                    13: "28.533",
                    14: "28.793",
                    15: "30.482",
                    16: "30.312",
                    17: "29.237",
                    18: "29.466",
                    19: "31.411",
                    20: "30.699",
                    21: "31.021",
                    22: "29.275",
                    23: "28.898",
                    24: "30.694",
                    25: "30.814",
                    26: "32.307",
                    27: "33.437",
                    28: "32.020",
                    29: "33.476",
                },
            }
        )
        # convert to dask
        self.rates_dd = dd.from_pandas(self.rates, npartitions=self.npartitions)

    """Below, we test all the dask operations of the Django tasks
        These functions are separated into isolated functions
        for enabling us to test them"""

    def test_netassets(self):
        a = NetAssetReport.calculate(self, self.trading_history_dd)
        self.assertEqual(
            list(a.columns), ["instrument", "time", "units", "price", "cumsum", "value"]
        )

    def test_correlation(self):
        a = CorrelationReport.calculate(self, self.rates_dd, "BCO_USD")
        self.assertEqual(list(a.columns), ["BCO_USD"])

    def test_exposure(self):
        a = ExposureReport.calculate(self, self.trading_history_dd)
        self.assertEqual(
            list(a.columns[0:4]), ["type", "divisionID", "siteID", "accountUserID"]
        )

    def test_financing(self):
        a = FinancingReport.calculate(self, self.trading_history_dd)
        self.assertEqual(list(a.columns), ["amount", "accountBalance", "financing"])

    def test_opentrades(self):
        a = OpenTradesReport.calculate(self, self.trading_history_dd)
        self.assertEqual(list(a.columns), ["time", "instrument", "units", "price"])

    def test_volatility(self):
        a = VolatilityReport.calculate(self, self.rates_dd)
        self.assertEqual(
            list(a.columns), ["complete", "volume", "o", "h", "l", "c", "vol", "mov"]
        )

    def test_shape(self):
        dsk = self.rates_dd
        self.assertEqual(dsk.compute().shape, (20, 7))
